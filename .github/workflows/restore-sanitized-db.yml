name: Restore Sanitized DB

concurrency: stage

on:
  push:
    branches: 
      - db-actions
  workflow_dispatch:
  workflow_call:

jobs:
  sanitize-db:
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Run default MySQL instance
        run: docker run --rm --detach --publish 3306:3306 --env MYSQL_ROOT_PASSWORD=root --name mysql --platform linux/amd64 mysql:5.7

      - name: Download DB backup
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: backup-db.yml
          workflow_conclusion: success
          check_artifacts: true

      - name: Show what was downloaded
        run: ls -lR

      - name: Stop MySQL instance
        run: docker stop mysql

# delete from invites;
# delete from user_webpush;
# update users set email='***';

  # backup-db:
  #   runs-on: [self-hosted, prod]
  #   environment: Production
  #   steps:
  #     - name: Set backup name
  #       run: echo "backupFileName=${HOSTNAME}_$(date +%Y-%m-%d_%H-%M-%S)_dump.sql" >> $GITHUB_ENV

  #     - name: Dump database
  #       env:
  #         MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
  #       run: docker-compose -f /orbitar/docker-compose.yml exec -T mysql mysqldump --default-character-set=utf8mb4 --single-transaction --add-drop-database --databases orbitar_db activity_db -u root -p$MYSQL_ROOT_PASSWORD > ${{ env.backupFileName }}
      
  #     - name: Compress database
  #       env:
  #         BACKUP_PASSWORD: ${{ secrets.BACKUP_PASSWORD }}
  #       run: zip -m -P $BACKUP_PASSWORD ${{ env.backupFileName }}.zip ${{ env.backupFileName }}

  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v3
  #       with:
  #         name: ${{ env.backupFileName }}
  #         path: ${{ env.backupFileName }}.zip
  #         if-no-files-found: error